# Database mapper from scratch

This database mapper is written for sqlx database library, mainly supporting postgres. It aims to be as lightweight as possible.

## TO DO

* belongs: doesn't fill belonging field's ID field
* has one
* has many

## In Scope

* maintains a database connection
* provides logrus logging
* provides health report on the connection
* provides basic query functionality on top of sqlx for logging purposes
* provides basic model query functionality (Find, FindBy, All, Create, Update, Delete)

## Out of Scope

* Transactions (for now)

## Map models

Models are structs, and mapper reads their "db" tags for meta-information. Some rules:

- Database table names are generated by struct names by converting to lower-cased, pluralized form. No snake-casing is taking place.
- Empty `db:"..."` tag names are not handled well. If there is a tag, it must be named.
- if the tag is "-" (just like in `db:"-"`), then that field will not be represented in the database
- if the tag is missing, sqlx uses a standard mapping: field name converted to lower case, and never `snake_case`.
- mapper accepts the following tag options (optional fields after a comma):
    - omitempty: if the field is empty in the model, it won't be added to Create / Update query
    - relation: it represents "has one" or "has many" relationships (depending on the field type)
    - belongs: represents "belongs_to" relationship. It assumes another field with the same name, but with `_id` suffix.

## Relations

### Belongs

When a struct "belongs to" another struct, it stores the other struct's ID like this:

```golang
type Message struct {
    ID    int
    Title string
    Body  string
}

type Comment struct {
    ID     int
    Title  string
    Body   string
    PostID int     `db:"post_id"`
    Post   Message `db:"post,belongs"`
}
```

In this case, Comment belongs to Message, and it's referenced internally as "post". It also requires a `post_id` field, as it will be stored in the table.

Selecting a Comment looks like this:

```golang
comment := &Comment{}
mapper.NewSelect(comment).Where(Eq("id", 1)).Join("post").All()
```

This query loads `comment` with an appropriate comment, with the data of `Post`, which is a `Message` object.
